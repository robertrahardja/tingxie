<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>笔画练习 - Chinese Handwriting Practice</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            box-sizing: border-box;
        }

        .handwriting-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .handwriting-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .handwriting-header h1 {
            font-size: 1.5rem;
            color: #333;
        }

        .input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #character-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
        }

        #character-input:focus {
            border-color: #4a90d9;
        }

        #start-btn {
            padding: 12px 20px;
            font-size: 1rem;
            background: #4a90d9;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            min-height: 48px;
        }

        #start-btn:hover {
            background: #357abd;
        }

        .practice-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 12px;
        }

        .character-display {
            text-align: center;
            margin-bottom: 16px;
        }

        #current-char {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        #pinyin {
            display: block;
            font-size: 1rem;
            color: #666;
            margin-top: 4px;
        }

        #writer-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        #character-target {
            width: 300px;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            position: relative;
        }

        #character-target::before,
        #character-target::after {
            content: '';
            position: absolute;
            background: #e0e0e0;
        }

        #character-target::before {
            left: 50%;
            top: 0;
            width: 1px;
            height: 100%;
        }

        #character-target::after {
            top: 50%;
            left: 0;
            width: 100%;
            height: 1px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .controls button {
            padding: 12px 8px;
            font-size: 0.9rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 48px;
        }

        .controls .nav-btn {
            background: #e0e0e0;
            color: #333;
        }

        .controls .nav-btn:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .controls .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls .action-btn {
            background: #4a90d9;
            color: white;
        }

        .controls .action-btn:hover {
            background: #357abd;
        }

        #reset-btn {
            background: #e74c3c;
        }

        #reset-btn:hover {
            background: #c0392b;
        }

        .status {
            text-align: center;
            font-size: 1rem;
            color: #27ae60;
            min-height: 24px;
            font-weight: 500;
        }

        .status.error {
            color: #e74c3c;
        }

        .instructions {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .instructions h2 {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: #333;
        }

        .instructions ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .instructions li {
            margin-bottom: 8px;
            color: #555;
            line-height: 1.4;
        }

        .instructions p {
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 400px) {
            .handwriting-container {
                padding: 12px;
            }

            .handwriting-header h1 {
                font-size: 1.3rem;
            }

            .input-section {
                flex-direction: column;
            }

            #character-target {
                width: 280px;
                height: 280px;
            }

            .controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container">
            <button class="menu-toggle" id="menu-toggle">
                <span class="hamburger"></span>
                <span class="hamburger"></span>
                <span class="hamburger"></span>
            </button>
            <div class="nav-menu" id="nav-menu">
                <a href="index.html" class="nav-item">听写练习</a>
                <a href="handwriting.html" class="nav-item active">笔画练习</a>
                <a href="instructions.html" class="nav-item">指示词汇</a>
                <a href="dashboard.html" class="nav-item">家长看板</a>
            </div>
        </div>
    </nav>

    <div class="handwriting-container">
        <header class="handwriting-header">
            <h1>笔画练习 Chinese Handwriting Practice</h1>
        </header>

        <div class="input-section">
            <input
                type="text"
                id="character-input"
                placeholder="输入要练习的字（例如：你好世界）"
                maxlength="50"
            />
            <button id="start-btn">开始练习</button>
        </div>

        <div class="practice-area" id="practice-area" style="display: none;">
            <div class="progress-bar">
                <span id="current-index">1</span> / <span id="total-chars">0</span>
            </div>

            <div class="character-display">
                <span id="current-char"></span>
                <span id="pinyin"></span>
            </div>

            <div id="writer-container">
                <div id="character-target"></div>
            </div>

            <div class="controls">
                <button id="prev-btn" class="nav-btn" disabled>上一个</button>
                <button id="hint-btn" class="action-btn">显示提示</button>
                <button id="reset-btn" class="action-btn">重置</button>
                <button id="next-btn" class="nav-btn">下一个</button>
            </div>

            <div class="status" id="status"></div>
        </div>

        <div class="instructions" id="instructions">
            <h2>使用说明 How to Use</h2>
            <ul>
                <li>输入你想练习的汉字 Enter Chinese characters you want to practice</li>
                <li>按正确的笔顺书写每一笔 Write each stroke in the correct order</li>
                <li>点击"显示提示"查看下一笔 Use "Show Hint" to see the next stroke</li>
                <li>点击"重置"清空并重试 Use "Reset" to clear and try again</li>
                <li>用上一个/下一个切换字符 Navigate between characters with Previous/Next</li>
            </ul>
            <p><strong>示例字符 Sample characters:</strong> 你好世界学习中文</p>
        </div>
    </div>

    <script type="module">
        import HanziWriter from 'https://cdn.jsdelivr.net/npm/hanzi-writer@3.7.3/+esm';

        const state = {
            characters: [],
            currentIndex: 0,
            writer: null,
            currentStroke: 0,
        };

        // DOM Elements
        const menuToggle = document.getElementById('menu-toggle');
        const navMenu = document.getElementById('nav-menu');
        const characterInput = document.getElementById('character-input');
        const startBtn = document.getElementById('start-btn');
        const practiceArea = document.getElementById('practice-area');
        const instructions = document.getElementById('instructions');
        const currentIndexEl = document.getElementById('current-index');
        const totalCharsEl = document.getElementById('total-chars');
        const currentCharEl = document.getElementById('current-char');
        const pinyinEl = document.getElementById('pinyin');
        const characterTarget = document.getElementById('character-target');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const hintBtn = document.getElementById('hint-btn');
        const resetBtn = document.getElementById('reset-btn');
        const statusEl = document.getElementById('status');

        // Menu toggle
        if (menuToggle && navMenu) {
            menuToggle.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!menuToggle.contains(e.target) && !navMenu.contains(e.target)) {
                    navMenu.classList.remove('active');
                }
            });
        }

        function isChinese(char) {
            const code = char.charCodeAt(0);
            return (
                (code >= 0x4e00 && code <= 0x9fff) ||
                (code >= 0x3400 && code <= 0x4dbf) ||
                (code >= 0x20000 && code <= 0x2a6df)
            );
        }

        function filterChineseCharacters(input) {
            return Array.from(input).filter(isChinese);
        }

        function updateNavigationButtons() {
            prevBtn.disabled = state.currentIndex === 0;
            nextBtn.disabled = state.currentIndex >= state.characters.length - 1;
        }

        function updateProgress() {
            currentIndexEl.textContent = String(state.currentIndex + 1);
            totalCharsEl.textContent = String(state.characters.length);
        }

        function setStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.className = isError ? 'status error' : 'status';
        }

        function loadCharacter(char) {
            characterTarget.innerHTML = '';
            currentCharEl.textContent = char;
            pinyinEl.textContent = '';
            setStatus('');

            state.writer = HanziWriter.create(characterTarget, char, {
                width: 300,
                height: 300,
                padding: 20,
                showOutline: true,
                showCharacter: false,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 100,
                strokeColor: '#333',
                outlineColor: '#ddd',
                drawingColor: '#4a90d9',
                drawingWidth: 20,
                showHintAfterMisses: 3,
                highlightOnComplete: true,
                highlightColor: '#27ae60',
                charDataLoader: (char) => {
                    return fetch(`https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`)
                        .then(res => {
                            if (!res.ok) throw new Error('Character not found');
                            return res.json();
                        });
                },
            });

            state.currentStroke = 0;
            state.writer.quiz({
                onMistake: (strokeData) => {
                    setStatus(`第 ${strokeData.strokeNum + 1} 笔: 再试一次！Stroke ${strokeData.strokeNum + 1}: Try again!`, true);
                },
                onCorrectStroke: (strokeData) => {
                    state.currentStroke = strokeData.strokeNum + 1;
                    setStatus(`第 ${strokeData.strokeNum + 1} 笔: 正确！Stroke ${strokeData.strokeNum + 1}: Correct!`);
                },
                onComplete: (summaryData) => {
                    const mistakes = summaryData.totalMistakes;
                    if (mistakes === 0) {
                        setStatus('完美！没有错误！Perfect! No mistakes!');
                    } else {
                        setStatus(`完成！${mistakes} 个错误。Complete! ${mistakes} mistake${mistakes > 1 ? 's' : ''}.`);
                    }
                },
            });
        }

        function startPractice() {
            const input = characterInput.value.trim();
            const chars = filterChineseCharacters(input);

            if (chars.length === 0) {
                alert('请至少输入一个汉字 Please enter at least one Chinese character.');
                return;
            }

            state.characters = chars;
            state.currentIndex = 0;

            practiceArea.style.display = 'block';
            instructions.style.display = 'none';

            updateProgress();
            updateNavigationButtons();
            loadCharacter(state.characters[0]);
        }

        function goToPrevious() {
            if (state.currentIndex > 0) {
                state.currentIndex--;
                updateProgress();
                updateNavigationButtons();
                loadCharacter(state.characters[state.currentIndex]);
            }
        }

        function goToNext() {
            if (state.currentIndex < state.characters.length - 1) {
                state.currentIndex++;
                updateProgress();
                updateNavigationButtons();
                loadCharacter(state.characters[state.currentIndex]);
            }
        }

        function showHint() {
            if (state.writer) {
                state.writer.highlightStroke(state.currentStroke);
            }
        }

        function resetCharacter() {
            if (state.writer) {
                loadCharacter(state.characters[state.currentIndex]);
            }
        }

        // Event listeners
        startBtn.addEventListener('click', startPractice);

        characterInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                startPractice();
            }
        });

        prevBtn.addEventListener('click', goToPrevious);
        nextBtn.addEventListener('click', goToNext);
        hintBtn.addEventListener('click', showHint);
        resetBtn.addEventListener('click', resetCharacter);

        // Touch swipe support
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchStartedInWriter = false;

        practiceArea.addEventListener('touchstart', (e) => {
            const target = e.target;
            touchStartedInWriter = characterTarget.contains(target);
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        practiceArea.addEventListener('touchend', (e) => {
            if (touchStartedInWriter) {
                touchStartedInWriter = false;
                return;
            }

            touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;

            const diffX = touchStartX - touchEndX;
            const diffY = Math.abs(touchStartY - touchEndY);

            if (Math.abs(diffX) > diffY) {
                handleSwipe(diffX);
            }
        }, { passive: true });

        function handleSwipe(diffX) {
            const swipeThreshold = 80;

            if (Math.abs(diffX) > swipeThreshold) {
                if (diffX > 0) {
                    goToNext();
                } else {
                    goToPrevious();
                }
            }
        }

        // Set default sample text
        characterInput.value = '你好';
    </script>
</body>
</html>
