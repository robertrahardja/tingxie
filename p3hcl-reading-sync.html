<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»‹ç»æˆ‘çš„ç‰©å“ - P3HCL é˜…è¯»ç»ƒä¹  (åŒæ­¥)</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: #f5f5f5;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .lesson-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .lesson-header h1 {
            font-size: 32px;
            margin: 0 0 10px 0;
        }

        .lesson-header .subtitle {
            font-size: 18px;
            opacity: 0.9;
        }

        .content-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .audio-controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .audio-player {
            width: 100%;
            max-width: 600px;
        }

        .play-btn {
            padding: 15px 40px;
            border-radius: 8px;
            border: none;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .reading-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .reading-title {
            font-size: 36px;
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .reading-paragraph {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            line-height: 2.2;
            font-size: 22px;
            margin-bottom: 20px;
            color: #333;
            text-indent: 2em;
        }

        .reading-paragraph:last-child {
            margin-bottom: 0;
        }

        /* Word highlighting */
        .word {
            display: inline;
            transition: all 0.2s ease;
            padding: 2px 1px;
            border-radius: 3px;
        }

        .word.active {
            border-bottom: 4px solid #667eea;
            font-weight: bold;
        }

        .word.past {
            opacity: 0.6;
        }

        .controls-bar {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .debug-info {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: monospace;
            font-size: 14px;
        }

        .debug-info div {
            margin: 5px 0;
        }

        .control-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            background: #4CAF50;
            color: white;
        }

        .control-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .control-btn.pause {
            background: #ff9800;
        }

        .control-btn.reset {
            background: #f44336;
        }

        @media (max-width: 768px) {
            .lesson-header h1 {
                font-size: 24px;
            }

            .reading-title {
                font-size: 28px;
            }

            .reading-paragraph {
                font-size: 20px;
                padding: 20px;
                line-height: 2;
            }

            .controls-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-container">
            <button class="menu-toggle" id="menu-toggle">
                <span class="hamburger"></span>
                <span class="hamburger"></span>
                <span class="hamburger"></span>
            </button>
            <div class="nav-menu" id="nav-menu">
                <a href="index.html" class="nav-item">å¬å†™ç»ƒä¹ </a>
                <a href="koushi25.html" class="nav-item">å£è¯•</a>
                <a href="vocabulary.html" class="nav-item">è¯æ±‡æµè§ˆ</a>
            </div>
        </div>
    </nav>

    <div class="lesson-header">
        <h1>ğŸ“ ä»‹ç»æˆ‘çš„ç‰©å“ (åŒæ­¥é«˜äº®)</h1>
        <div class="subtitle">P3HCL Reading Practice with Synchronized Highlighting</div>
    </div>

    <div class="content-container">
        <div class="controls-bar">
            <button class="control-btn" onclick="playAudio()">ğŸ”Š æ’­æ”¾æœ—è¯»</button>
            <button class="control-btn pause" onclick="pauseAudio()">â¸ æš‚åœ</button>
            <button class="control-btn reset" onclick="resetAudio()">ğŸ”„ é‡æ–°å¼€å§‹</button>
        </div>

        <div class="debug-info" id="debug-info">
            <div>Audio Time: <span id="audio-time">0.00</span>s</div>
            <div>Current Char: <span id="current-char">-</span></div>
            <div>Char Timing: <span id="char-timing">-</span></div>
        </div>

        <div class="audio-controls">
            <audio id="reading-audio" class="audio-player" controls>
                <source src="audio/koushi/P3HCL_3.mp4" type="audio/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
            </audio>
        </div>

        <div class="reading-container">
            <div class="reading-title">ã€Šä»‹ç»æˆ‘çš„ç‰©å“ã€‹</div>
            <div id="reading-content" class="reading-content">
                <!-- Content will be loaded via JavaScript with word-level timing -->
            </div>
        </div>
    </div>

    <script>
        const audio = document.getElementById('reading-audio');
        let paragraphData = [];
        let currentCharIndex = -1;

        // Load formatted timing data with punctuation and paragraphs
        async function loadTimingData() {
            try {
                const response = await fetch('audio/koushi/P3HCL_3_formatted_timing.json');
                const data = await response.json();
                paragraphData = data.paragraphs;
                renderContent();
            } catch (error) {
                console.error('Error loading timing data:', error);
                // Fallback to non-synchronized version
                document.getElementById('reading-content').innerHTML = `
                    <div class="reading-paragraph">æ—¶é—´æ•°æ®åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºåŸæ–‡æœ¬...</div>
                `;
            }
        }

        // Render content with character-level spans
        function renderContent() {
            const content = document.getElementById('reading-content');
            let html = '';

            paragraphData.forEach((para, paraIndex) => {
                html += '<div class="reading-paragraph">';

                para.chars.forEach((charData, charIndex) => {
                    const globalIndex = paraIndex * 1000 + charIndex; // Create unique index
                    html += `<span class="word" data-para="${paraIndex}" data-char="${charIndex}" data-start="${charData.start}" data-end="${charData.end}">${charData.char}</span>`;
                });

                html += '</div>';
            });

            content.innerHTML = html;
        }

        // Helper function to check if a character is punctuation
        function isPunctuation(char) {
            const punctuation = `ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š""''ï¼ˆï¼‰ã€`;
            return punctuation.includes(char);
        }

        // Helper function to get word boundaries around a character
        function getWordBoundaries(chars, activeIndex) {
            if (activeIndex === -1) return [];

            const charElements = Array.from(chars);
            let start = activeIndex;
            let end = activeIndex;

            // Expand backwards to find word start
            while (start > 0) {
                const prevChar = charElements[start - 1].textContent;
                if (isPunctuation(prevChar) || prevChar === ' ') break;
                start--;
            }

            // Expand forwards to find word end
            while (end < charElements.length - 1) {
                const nextChar = charElements[end + 1].textContent;
                if (isPunctuation(nextChar) || nextChar === ' ') break;
                end++;
            }

            return charElements.slice(start, end + 1);
        }

        // Update highlighting based on current time
        function updateHighlight() {
            const currentTime = audio.currentTime;
            const chars = document.querySelectorAll('.word');

            // Update debug info
            document.getElementById('audio-time').textContent = currentTime.toFixed(2);

            // Find the current character by checking all characters
            let activeChar = null;
            let activeIndex = -1;

            chars.forEach((char, index) => {
                const start = parseFloat(char.dataset.start);
                const end = parseFloat(char.dataset.end);

                // Remove all classes first
                char.classList.remove('active', 'past');

                // Check if this is the current character
                if (currentTime >= start && currentTime < end) {
                    if (!activeChar || start > parseFloat(activeChar.dataset.start)) {
                        activeChar = char;
                        activeIndex = index;
                    }
                } else if (currentTime >= end) {
                    char.classList.add('past');
                }
            });

            // Apply active class to the entire word
            if (activeChar) {
                const wordChars = getWordBoundaries(chars, activeIndex);
                wordChars.forEach(char => {
                    char.classList.add('active');
                    char.classList.remove('past'); // Remove 'past' if it was added
                });

                currentCharIndex = activeIndex;

                // Update debug info
                const start = parseFloat(activeChar.dataset.start);
                const end = parseFloat(activeChar.dataset.end);
                const wordText = wordChars.map(c => c.textContent).join('');
                document.getElementById('current-char').textContent = wordText;
                document.getElementById('char-timing').textContent = `${start.toFixed(2)}s - ${end.toFixed(2)}s`;

                // Scroll into view smoothly
                const rect = activeChar.getBoundingClientRect();
                if (rect.bottom > window.innerHeight - 100 || rect.top < 100) {
                    activeChar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                document.getElementById('current-char').textContent = '-';
                document.getElementById('char-timing').textContent = '-';
            }
        }

        // Audio event listeners
        audio.addEventListener('timeupdate', updateHighlight);

        function playAudio() {
            audio.play();
        }

        function pauseAudio() {
            audio.pause();
        }

        function resetAudio() {
            audio.currentTime = 0;
            audio.play();
        }

        // Mobile navigation
        document.getElementById('menu-toggle').addEventListener('click', function() {
            document.getElementById('nav-menu').classList.toggle('active');
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const menuToggle = document.getElementById('menu-toggle');
            const navMenu = document.getElementById('nav-menu');

            if (!menuToggle.contains(e.target) && !navMenu.contains(e.target)) {
                navMenu.classList.remove('active');
            }
        });

        // Initialize
        loadTimingData();
    </script>
</body>
</html>
